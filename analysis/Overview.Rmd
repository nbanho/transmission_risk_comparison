---
title: "Transmission Risk Comparison"
author: "Remo Schmutz"
date: "2022-12-21"
output:
  pdf_document: default
  html_document: default
  keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(scipen = 999)
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      cache = TRUE)
```

## Libraries 

```{r libraries}
library(tidyverse)
library(ggplot2)
require("knitr")
library(gridExtra)
library(grid)
library(lubridate)
library(dplyr)
library(hms)
library(truncdist)
library(crch)
library(stats)
library(LaplacesDemon)
library(ggstatsplot)
library(MASS)
library(fitdistrplus)
library(truncnorm)
library(tidybayes)
library(ggpubr)
```

## Data 

```{r data import}
ch <- readRDS("data-clean/co2-ch.rds") #swiss data
satz <- readRDS("data-clean/co2-sa-tz.rds")

ch <- ch %>% 
  filter(co2 > 400) %>% 
  arrange(co2)

ch1 <- ch %>% 
  filter(school == "School 1")

ch2 <- ch %>% 
  filter(school == "School 2")

sa <- satz %>% 
  filter(country == "South Africa") %>% 
  filter(co2 < 3000) %>% 
  filter(co2 > 400) %>% 
  arrange(co2)#south africa data

tz <- satz %>% 
  filter(country == "Tanzania") %>% 
  filter(co2 < 3000) %>%
  filter(co2 > 400) %>% 
  mutate(time_h = hour(date)) %>% 
  filter(time_h >= 8) %>% 
  arrange(co2) #tanzania data

```

## Methods

Indoor Co2 concentration \
  * mean or distribution from data<br> \
* $C_o:=$ Outdoor Co2 concentration<br>
  * from literature https://www.fsis.usda.gov/sites/default/files/media_file/2020-08/Carbon-Dioxide.pdf \
* $C_a:=$ Volume fraction of CO2 added to exhaled breath during breathing \
  * Persily and de Jonge [Table 3 and 4] doi: 10.1111/ina.12383 \
* $\bar{f}:=$ $\int_{t=0}^{t=max}f dt$ \
  * integrating over f values from different times $(2)$ or using a distribution based on the data \
* $I:=$ Number of infectors in the class \
  * estimated using prevalence of the age group in the country \
* $q:=$ Quantum per hour \
  * assuming a distribution from literature \
* $t:=$ time \
  * changing this parameter to compare \
* $n:=$ number of people in the class \
  * data (Switzerland) or assumption (South Africa, Tanzania) \

## Preprocess

```{r preprocess}
ch_hourly <- ch %>%
  mutate(time_h = hour(time)) %>%
  group_by(school, time_h) %>%
  summarize(mean = mean(co2),
            lower = quantile(co2, 0.25),
            upper = quantile(co2, 0.75),
            n_data = n()) %>%
  ungroup()

ch_hourly %>%
  ggplot(aes(x = time_h, y = n_data, fill = school)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Daytime (h)") +
  ylab("number of measurements") +
  ggtitle("Temporal distribution of measurements (Switzerland)") +
  theme_bw() +
  theme(legend.position = c(0.9,0.9), legend.title = element_blank()) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2")
# there is a reasonable number of data points per hour but missing data at hour 12 for school 2 (no lessons)

tz_hourly <- tz %>%
  mutate(time_h = hour(date)) %>%
  group_by(time_h) %>%
  summarize(mean = mean(co2),
            lower = quantile(co2, 0.25),
            upper = quantile(co2, 0.75),
            n_data = n()) %>%
  ungroup()

tz_hourly %>%
  ggplot(aes(x = time_h, y = n_data)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  xlab("Daytime (h)") +
  ylab("number of measurements") +
  ggtitle("Temporal distribution of measurements (Tanzania)") +
  theme_bw() +
  theme(legend.position = c(0.9,0.9), legend.title = element_blank())

# data is measured throughout the day in south africa

```

## Analysis 

### Co2 over time 

```{r}
ch_hourly %>% #plot co2 during the day (ch)
  ggplot(aes(x = time_h, group = school, color = school)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2, position =    position_dodge2(width = .2)) +
  geom_point(aes(y = mean), position = position_dodge2(width = .2)) +
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(breaks = seq(7, 16, 1)) +
  labs(x = "Daytime (h)", y = "CO2 (Mean and IQR)") +
  theme_bw() +
  theme(legend.position = c(0.9,0.9), legend.title = element_blank()) +
  ggtitle("Co2 values during a day (Switzerland)")

tz_hourly %>% #plot co2 during the day (tz)
  ggplot(aes(x = time_h)) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .2, position =    position_dodge2(width = .2)) +
  geom_point(aes(y = mean), position = position_dodge2(width = .2)) +
  scale_color_brewer(palette = "Set2") +
  scale_x_continuous(breaks = seq(7, 17, 1)) +
  labs(x = "Daytime (h)", y = "CO2 (Mean and IQR)") +
  theme_bw() +
  theme(legend.position = c(0.9,0.9), legend.title = element_blank()) +
  ggtitle("Co2 values during a day (Tanzania)")

#no time data available for south africa
```

### Smoothing Data

```{r}
# CH
##school 1
set.seed(1)

dat_ch1 <- data.frame(
  x = 1:length(ch1$co2),
  y = ch1$co2
)

loessData_ch1 <- data.frame(
  x = 1:length(ch1$co2),
  y = predict(loess(y~x, dat_ch1, span = 0.1)),
  method = "loess()"
) %>% 
  mutate(school = "school 1")

ggplot(loessData_ch1, aes(x, y)) + 
  geom_point(dat = dat_ch1, aes(x, y), alpha = 0.2, col = "red") +
  geom_line(col = "blue") +
  facet_wrap(~method) +
  theme_bw(16)

##school 2
dat_ch2 <- data.frame(
  x = 1:length(ch2$co2),
  y = ch2$co2
)

loessData_ch2 <- data.frame(
  x = 1:length(ch2$co2),
  y = predict(loess(y~x, dat_ch2, span = 0.3)),
  method = "loess()"
) %>% 
  mutate(school = "school 2")

ggplot(loessData_ch2, aes(x, y)) + 
  geom_point(dat = dat_ch2, aes(x, y), alpha = 0.2, col = "red") +
  geom_line(col = "blue") +
  facet_wrap(~method) +
  theme_bw(16)

loessData_ch <- rbind(loessData_ch1,loessData_ch2)

# TZ
dat_tz <- data.frame(
  x = 1:length(tz$co2),
  y = tz$co2
)

loessData_tz <- data.frame(
  x = 1:length(tz$co2),
  y = predict(loess(y~x, dat_tz, span = 0.3)),
  method = "loess()"
)

ggplot(loessData_tz, aes(x, y)) + 
  geom_point(dat = dat_tz, aes(x, y), alpha = 0.2, col = "red") +
  geom_line(col = "blue") +
  facet_wrap(~method) +
  theme_bw(16)

# SA
dat_sa <- data.frame(
  x = 1:length(sa$co2),
  y = sa$co2
)

loessData_sa <- data.frame(
  x = 1:length(sa$co2),
  y = predict(loess(y~x, dat_sa, span = 0.3)),
  method = "loess()"
)

ggplot(loessData_sa, aes(x, y)) + 
  geom_point(dat = dat_sa, aes(x, y), alpha = 0.2, col = "red") +
  geom_line(col = "blue") +
  facet_wrap(~method) +
  theme_bw(16)

```

### Co2 distribution

```{r}
loessData_ch %>% #density plot ch
  ggplot(aes(x = y, color = school, fill = school)) +
  geom_density(alpha = .2, kernel = "gaussian", adjust = 3) +
  scale_x_continuous(expand = c(0,0)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),limits = c(0, 0.004)) +
  scale_x_continuous(limits = c(400, 3000)) +
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  theme_bw() +
  theme(legend.position = c(0.9,0.9), legend.title = element_blank()) +
  ggtitle("Probability distribution of observed Co2-values (Switzerland)")

loessData_sa %>% #density plot sa smooth
  ggplot(aes(x = y)) +
  geom_density(alpha = .2, kernel = "gaussian", adjust = 4, fill = "darkseagreen3") +
  scale_x_continuous(expand = c(0,0)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(limits = c(0, 0.002)) +
  scale_x_continuous(limits = c(400, 3000)) +
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  theme(legend.position = "none") +
  theme_bw() +
  ggtitle("Probability distribution of observed Co2-values (South Africa)")

loessData_tz %>% #density plot tz smooth
  ggplot(aes(x = y)) +
  geom_density(alpha = .2, kernel = "gaussian", adjust = 3.2) +
  scale_x_continuous(expand = c(0,0)) +
  scale_color_brewer(palette = "Set2") +
  scale_fill_brewer(palette = "Set2") +
  scale_y_continuous(limits = c(0, 0.0075)) +
  scale_x_continuous(limits = c(400, 3000)) +
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  theme_bw() +
  theme(legend.position = c(0.9,0.9), legend.title = element_blank()) +
  ggtitle("Probability distribution of observed Co2-values (Tanzania)")
```
### Distribution co2

```{r distribution for co2 ch1}
#C_a
C_a <- ((0.0042)*60)/8 #https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5666301/ mean girls (11-16 and 16-21), boys (11-16 and 16-21) for co2 production rate per minute, the breathing rate (8) comes from Rudnick paper

#C_o
C_o <- 400 #p.p.m (taking a higher estimate because higher values ar possible when a lot of traffic ect.)
## all schools are directly on the side of a road (no info for tanzania), so i won't make a distinction

#school1
x_ch1 <- ch %>% 
  filter(school == "School 1") %>% 
  pull(co2)

descdist(x_ch1, discrete = FALSE) #normal distribution fits well
fitdistr(x_ch1, "gamma") #get parameters

x <- seq(400, 3000, by = .1)

co2_distr_ch1 <- data.frame(co2 = seq(400, 3000, .1)) %>% 
  mutate(prob = dtrunc(co2, spec = "gamma", a = 400, b = 3000, shape = 15.5, rate = 0.017) )

plot_co2_ch1 <- co2_distr_ch1 %>% 
  ggplot(aes(x=x,y=y_ch1)) +
  geom_line(color= "red") +
  ggtitle("Switzerland / School 1")+#plot density
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 0.004))  +
  scale_x_continuous(limits = c(400, 3000))

sample_co2_ch1 <- sample(co2_distr_ch1$co2, 10000, replace = TRUE, prob = co2_distr_ch1$prob) #sample co2
sample_f_ch1 <- tibble(co2 = sample_co2_ch1, f = ((co2-C_o)/C_a)/1000000) %>% #sample f
  dplyr::select(-co2)

####histogram / density comparison
hist(loessData_ch1$y, # histogram
 col="peachpuff", # column color
 border="black",
 prob = TRUE, # show densities instead of frequencies
 xlab = "co2",
 main = "Data vs Model",
 breaks = 7,
 xlim = c(400,1800),
 ylim = c(0,0.003))
lines(co2_distr_ch1, # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")

```

```{r distribution for co2 ch2}
#school 2
x_ch2 <- loessData_ch2 %>% 
  pull(y) #pull filtered data

descdist(x_ch2, discrete = FALSE) #gamma fits ok 
fitdistr(x_ch2, "gamma") #get parameters

co2_distr_ch2 <- data.frame(co2 = seq(400, 3000, .1)) %>% #create data frame
  mutate(prob = dtrunc(x, spec = "gamma", a = 400, b = 3000, shape = 6.55, rate = 0.006)) 
#7.4
plot_co2_ch2 <- co2_distr_ch2 %>% #plots density
  ggplot(aes(x=x,y=y_ch2)) +
  geom_line(color= "red") +
  ggtitle("Switzerland / School 2")+#plot density
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  theme_bw() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 0.004))  +
  scale_x_continuous(limits = c(400, 3000))

sample_co2_ch2 <- sample(co2_distr_ch2$co2, 10000, replace = TRUE, prob = co2_distr_ch2$prob) #sample
sample_f_ch2 <- tibble(co2 = sample_co2_ch2, f = ((co2-C_o)/C_a)/1000000) %>% 
  dplyr::select(-co2)

####histogram / density comparison
hist(loessData_ch2$y, # histogram
 col="peachpuff", # column color
 border="black",
 prob = TRUE, # show densities instead of frequencies
 xlab = "co2",
 main = "Data vs Model",
 breaks = 7,
 xlim = c(400,2500),
 ylim = c(0,0.0015))
lines(co2_distr_ch2, # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")

```

```{r distribution for co2 tz}
#tanzania
x_tz <- loessData_tz %>% 
  pull(y)

x_tz <- as.numeric(x_tz)

descdist(x_tz, discrete = FALSE, boot = 100) #gamma fits ok
fitdistr(x_tz, "t") #get parameters

co2_distr_tz <- data.frame(co2 = seq(400, 3000, .1)) %>% 
  mutate(prob = dtrunc(x, spec = "st", a = 400, b = 3000, mu = 593.95, sigma = 80, nu = 1.55))

plot_co2_tz <- co2_distr_tz %>% 
  ggplot(aes(x=x,y=y_tz)) +
  geom_line(color= "red") +
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  ggtitle("Tanzania") +
  theme_bw() +
  scale_y_continuous(limits = c(0, 0.0075)) +
  scale_x_continuous(limits = c(400, 3000))

sample_co2_tz <- sample(co2_distr_tz$co2, 10000, replace = TRUE, prob = co2_distr_tz$prob) #sample
sample_f_tz <- tibble(co2 = sample_co2_tz, f = ((co2-C_o)/C_a)/1000000) %>% 
  dplyr::select(-co2)

####histogram / density comparison
hist(loessData_tz$y, # histogram
 col="peachpuff", # column color
 border="black",
 prob = TRUE, # show densities instead of frequencies
 xlab = "co2",
 main = "Data vs Model",
 breaks = 14,
 xlim = c(400, 1600),
 ylim = c(0,0.006))
lines(co2_distr_tz, # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")

```


```{r distribution for co2 sa}
#south africa
x_sa <- loessData_sa %>% 
  pull(y)

x_sa <- as.numeric(x_sa)

descdist(x_sa, discrete = FALSE) #normal/gamma fits ok -> after comparison --> gamma is better
fitdistr(x_sa, "gamma") #get parameters

co2_distr_sa <- data.frame(co2 = seq(400, 3000, .1)) %>% 
  mutate(prob = dtrunc(x, spec = "gamma", a = 400, b = 3000, shape = 5.72, rate = 0.0039))

plot_co2_sa <- co2_distr_sa %>% 
  ggplot(aes(x=x,y=y_sa)) +
  geom_line(color= "red") +
  labs(x = expression(CO[2]*" (ppm)"), y = "Density") +
  ggtitle("South Africa") +
  theme_bw() +
  scale_y_continuous(limits = c(0, 0.002)) +
  scale_x_continuous(limits = c(400, 3000))

sample_co2_sa <- sample(co2_distr_sa$co2, 10000, replace = TRUE, prob = co2_distr_sa$prob) #sample
sample_f_sa <- tibble(co2 = sample_co2_sa, f = ((co2-C_o)/C_a)/1000000) %>% 
  dplyr::select(-co2)

####histogram / density comparison
hist(loessData_sa$y, # histogram
 col="peachpuff", # column color
 border="black",
 prob = TRUE, # show densities instead of frequencies
 xlab = "co2",
 main = "Data vs Model",
 breaks = 10, 
 xlim = c(400, 3000),
 ylim = c(0,0.001))
lines(co2_distr_sa, # density plot
 lwd = 2, # thickness of line
 col = "chocolate3")

```

```{r plot}

#ggarrange(plot_co2_ch1, plot_co2_ch2, plot_co2_sa, plot_co2_tz, 
     #     labels = c("A", "B", "C", "D"),
      #    ncol = 2, nrow = 2)

```


## Quanta

I'll use the following studies for calculating the meanparameter: <br>

  Riley (1962): 130 patients, q: 1.25 <br>
  Escombe (2008): 117 patients, q: 8.2 <br>
  Nardell (1991) : 1 patients, q: 12.5 <br>
  Andrews (2014) : 571 patients, q: 0.89 <br>

```{r quanta tb}

q <- (1.25*130+8.2*117+12.5+0.89*571)/(130+117+1+571) #weighted mean from different studies

#Escombe Table 2
mean_one_inf <- mean(c(12,3,5.5,1.8,18,12)) #mean quanta of pers. which infected one pig
mean_two_inf <- mean(c(2.9,40)) #mean quanta of pers. which infected two pigs

q_inf_persons <- c(12,3,2.9,5.5,1.8,18,40,12,226,52,mean_two_inf,rep(mean_one_inf,11)) 
q_sample_total_norm <- c(q_inf_persons, rtruncnorm(117-length(q_inf_persons), a = 0, mean = 1, sd = 1))

fitdistr(q_sample_total_norm, "t") #get parameters

dq <- function(x) {
  dtrunc(x, spec = "st", a = 0, b = 300, mu = 1, sigma = 0.67, nu = 0.90) #parameters from fitdistr
}

rq_distr <- data.frame(quanta = seq(0, 300, .1)) %>% 
  mutate(prob = dq(quanta))

rq_distr %>% 
  ggplot(aes(x = quanta, y = prob)) +
  geom_line()+
  theme_bw() +
  xlab("Quanta") +
  ylab("Density")#Distribution of the quanta model

sample_q <- sample(rq_distr$quanta, 10000, replace = TRUE, prob = rq_distr$prob) #sample q for calculation later
sample_q
tb_sample <- tibble(sample = sample_q) %>% 
  count(sample > 10) %>% 
  mutate(prob = n/10000) #what is the ratio of datapoints over 10?

q_under_10 <- tb_sample[1,3, drop = TRUE]
q_under_10 # approx. 96% of data points are below 10

mean(sample_q) #mean of the sample should be between 2 and 3
plot(sample_q, ylab="Quanta")

thousand_sample <- replicate(10000, mean(sample(rq_distr$quanta, 1000, replace = TRUE, prob = rq_distr$prob))) 
#for calculating the distribution of the mean over lots of simulations
ggplot() + geom_density(mapping = aes(thousand_sample), alpha = .2, kernel = "gaussian", adjust = 5) +
  xlab("Mean of simulated q-value") +
  ylab("Density") +
  theme_bw()
#Mean is in the desired area

```

```{r quanta covid}
## Buonanno et al. provide an estimation for the quanta (like in MCID)
#"light activity, speaking"
cov_q <- function(x) {
  dtrunc(x, spec = "lnorm", a = 0, meanlog = 0.698, sdlog = 0.720)
}

cov_q_distr <- data.frame(quanta = seq(0, 25, .1)) %>% 
  mutate(prob = cov_q(quanta))

cov_q_distr %>% 
  ggplot(aes(x = quanta, y = prob)) +
  geom_line() + 
  theme_bw() +
  ylab("Density") +
  xlab("Quanta")

sample_q_cov <- sample(cov_q_distr$quanta, 10000, replace = TRUE, prob = cov_q_distr$prob)

```
## Rest of the parameters

```{r parameters}
#n
n_ch <- 20
n_sa <- 30 #Powerpoint
n_tz <- 50 #Powerpoint

#I tuberculosis
prev_ch <- 4.14/100000
#https://www.bag.admin.ch/bag/de/home/zahlen-und-statistiken/zahlen-zu-infektionskrankheiten.exturl.html/aHR0cHM6Ly9tZWxkZXN5c3RlbWUuYmFnYXBwcy5jaC9pbmZyZX/BvcnRpbmcvZGF0ZW5kZXRhaWxzL2QvdHViZXJrdWxvc2UuaHRt/bD93ZWJncmFiPWlnbm9yZQ==.html

prev_sa <- 513/100000
# tendenziell zu hoch da 15-25
 #https://worldhealthorg.shinyapps.io/tb_profiles/?_inputs_&entity_type=%22country%22&lan=%22EN%22&iso2=%22ZA%22 von Abbildung abgelesen (kids) 5-14 und 15-24
# Ansteckungen in Altersgruppe 5-24 durch Population in dieser Altersgruppe (nicht 15-24 genommen, da sonst eher zu hoch weil Inzidenz dann ab 20 stark steigt)
prev_tz <- 208/100000
#https://data.worldbank.org/indicator/SH.TBS.INCD?locations=TZ

I_ch <- prev_ch*n_ch #prevalence per class (per year)
I_sa <- prev_sa*n_sa
I_tz <- prev_tz*n_tz

#I Covid
I_ch_cov <- 0.05*n_ch
40000/8700000

month <- 8*5*4
year <- 8*5*4*12
```

```{r preparing}
#preparing datasets for plotting
df_ch1 <- tibble(school = c(rep("school 1", 10000)), f = sample_f_ch1, q_tb = sample_q, q_cov = sample_q_cov) %>% 
  mutate(P_year = 1 - exp(-(f*I_ch*q_tb*year)/n_ch)) %>% 
  mutate(P_year_one = 1 - exp(-(f*1*q_tb*year)/n_ch)) %>% 
  mutate(P_month_one_cov = 1 - exp(-(f*1*q_cov*month)/n_ch)) %>% 
  mutate(P_month_two_cov = 1 - exp(-(f*2*q_cov*month)/n_ch)) %>% 
  mutate(five_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[2]) %>% 
  mutate(ninefive_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[20])

df_ch2 <- tibble(school = c(rep("school 2", 10000)), f = sample_f_ch2, q_tb = sample_q, q_cov = sample_q_cov) %>% 
  mutate(P_year = 1 - exp(-(f*I_ch*q_tb*year)/n_ch)) %>% 
  mutate(P_year_one = 1 - exp(-(f*1*q_tb*year)/n_ch)) %>% 
  mutate(P_month_one_cov = 1 - exp(-(f*1*q_cov*month)/n_ch)) %>% 
  mutate(P_month_two_cov = 1 - exp(-(f*2*q_cov*month)/n_ch)) %>% 
  mutate(five_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[2]) %>% 
  mutate(ninefive_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[20])
  
df_tz <- tibble(school = c(rep("tanzania", 10000)), f = sample_f_tz, q_tb = sample_q, q_cov = sample_q_cov) %>% 
  mutate(P_year = 1 - exp(-(f*I_tz*q_tb*year)/n_tz)) %>% 
  mutate(P_year_one = 1 - exp(-(f*1*q_tb*year)/n_tz)) %>% 
  mutate(P_month_one_cov = 1 - exp(-(f*1*q_cov*month)/n_tz)) %>% 
  mutate(P_month_two_cov = 1 - exp(-(f*2*q_cov*month)/n_ch)) %>% 
  mutate(five_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[2]) %>% 
  mutate(ninefive_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[20])

df_sa <- tibble(school = c(rep("south africa", 10000)), f = sample_f_sa, q_tb = sample_q, q_cov = sample_q_cov) %>% 
  mutate(P_year = 1 - exp(-(f*I_sa*q_tb*year)/n_sa)) %>% 
  mutate(P_year_one = 1 - exp(-(f*1*q_tb*year)/n_sa)) %>% 
  mutate(P_month_one_cov = 1 - exp(-(f*1*q_cov*month)/n_sa)) %>% 
  mutate(P_month_two_cov = 1 - exp(-(f*2*q_cov*month)/n_ch)) %>% 
  mutate(five_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[2]) %>% 
  mutate(ninefive_quantil = unname(quantile(P_year$f, probs = seq(0, 1, 1/20)))[20])

df_complet <- bind_rows(df_ch1, df_ch2, df_sa, df_tz)
```

## Plots of the transmission risk 

```{r plotting}
df_complet %>% 
  ggplot(aes(x = school, y=P_year$f))+
  scale_y_continuous(labels = scales::percent_format(scale = 100), breaks = c(0,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1), trans = "sqrt")+
  xlab("Country") + 
  ylab("Yearly risk of infection") +
  theme_bw() +
  geom_boxplot(width=0.3, color="black", alpha=0.2, outlier.shape = NA) +
  geom_point(aes(x=1,y=unname(quantile(df_ch1$P_year$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=2,y=unname(quantile(df_ch2$P_year$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=3,y=unname(quantile(df_sa$P_year$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=4,y=unname(quantile(df_tz$P_year$f, probs = 0.95))),colour="red")
  
df_complet %>% 
  ggplot(aes(x = school, y=P_month_one_cov$f))+
  scale_y_continuous(labels = scales::percent_format(scale = 100), breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1))+
  xlab("Country") + 
  ylab("Monthly risk of infection (one infected person)") +
  theme_bw() +
  geom_boxplot(width=0.3, color="black", alpha=0.2, outlier.shape = NA) +
  geom_point(aes(x=1,y=unname(quantile(df_ch1$P_month_one_cov$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=2,y=unname(quantile(df_ch2$P_month_one_cov$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=3,y=unname(quantile(df_sa$P_month_one_cov$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=4,y=unname(quantile(df_tz$P_month_one_cov$f, probs = 0.95))),colour="red")

df_complet %>% 
  ggplot(aes(x = school, y=P_month_two_cov$f))+
  scale_y_continuous(labels = scales::percent_format(scale = 100), breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1))+
  xlab("Country") + 
  ylab("Monthly risk of infection (two infected persons)") +
  theme_bw() +
  geom_boxplot(width=0.3, color="black", alpha=0.2, outlier.shape = NA) +
  geom_point(aes(x=1,y=unname(quantile(df_ch1$P_month_two_cov$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=2,y=unname(quantile(df_ch2$P_month_two_cov$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=3,y=unname(quantile(df_sa$P_month_two_cov$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=4,y=unname(quantile(df_tz$P_month_two_cov$f, probs = 0.95))),colour="red")

```

Now I will compare the risks of infection, assuming that the prevalence is the same for every country and also assuming that the class size is the same. The prevalence per country is not used. This is to highlight the influence of air quality.

```{r same incidence}
df_complet %>% 
 ggplot(aes(x = school, y=P_year_one$f))+
  scale_y_continuous(labels = scales::percent_format(scale = 100), breaks = c(0,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1), trans = "exp")+
  xlab("Country") + 
  ylab("Yearly risk of infection") +
  theme_bw() +
  geom_boxplot(width=0.3, color="black", alpha=0.2, outlier.shape = NA) +
  geom_point(aes(x=1,y=unname(quantile(df_ch1$P_year_one$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=2,y=unname(quantile(df_ch2$P_year_one$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=3,y=unname(quantile(df_sa$P_year_one$f, probs = 0.95))),colour="red") +
  geom_point(aes(x=4,y=unname(quantile(df_tz$P_year_one$f, probs = 0.95))),colour="red")

```
